<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>新零售便利店</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="{{ url_for('static',filename='js/addTable.js') }}"></script>
    <script src="{{ url_for('static',filename='js/sendMessage.js') }}"></script>
    <script src="{{ url_for('static',filename='js/inputSelect.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
        <!-- BOOTSTRAP STYLES-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.css') }}">
    <!-- FONTAWESOME STYLES-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.css') }}">
    <!--CUSTOM BASIC STYLES-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/basic.css') }}">
    <!--CUSTOM MAIN STYLES-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <!-- GOOGLE FONTS-->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <script>
        var tabProduct1 = document.getElementById("tabProduct");
        EditTables(tabProduct1);
    </script>
    <script>
         $(function () {
                $.ajax({
                    type: 'POST',
                    url: '/init',
                    contentType: 'application/json',
                    success: function(data){
                        var arr1=data.split(" ");
                        var obj=document.getElementById("telUserName");
                        var j=1;
                        for(var i=0;i<arr1.length;i++){
                            if(i%3==0)
                            {
                                obj.options[j]=new Option((arr1[i]+":"+arr1[i+1]+":"+arr1[i+2]),"新值");
                                j=j+1;
                            }
                        }
                    },
                    error: function(jqXHR){console.log(jqXHR)},
                })
        });
    </script>
</head>

<body>

<hr width="72%" style="position:absolute;top:-20px;left:200px;height:1px;border:none;border-top:5px solid #00FF00;" />
<!--用户注册及基本信息显示-->
<div class="left_top">
    <video id="v" style="width: 160px;height: 120px;position: relative;top:25px;"></video>
    <canvas id="canvas" style="display:none;width: 160px;height: 120px;position: relative;top:25px;"></canvas>
    <button type="button" class="btn btn-lg btn-default" id="start">开启摄像</button>
    <button type="button" class="btn btn-lg btn-primary" id="tp">拍照</button>
    <button type="button" class="btn btn-lg btn-success" id="upload">人脸识别</button>
    <h1 style="font-size:20px;position:absolute;top:255px">购买信息</h1>
    <script>
        var t;
        var videoPlaying = false;
        var take = false;
        let v = document.getElementById('v');
        let canvas = document.getElementById('canvas');
        // {# 开启摄像头方法#}
        document.getElementById("start").addEventListener("click", function () {
            // {#显示摄像头控件，隐藏图片控件#}
            v.style.display = 'block';
            canvas.style.display = 'none';

            // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
            }
            if (navigator.mediaDevices.getUserMedia === undefined) {
                navigator.mediaDevices.getUserMedia = function (constraints) {
                    // 首先，如果有getUserMedia的话，就获得它
                    var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

                    // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }

                    // 否则，为老的navigator.getUserMedia方法包裹一个Promise
                    return new Promise(function (resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                }
            }
            const constraints = {
                video: true,
                audio: false

            };
            let promise = navigator.mediaDevices.getUserMedia(constraints);
            promise.then(stream => {
                t = stream.getTracks()[0];
                // 旧的浏览器可能没有srcObject
                if ("srcObject" in v) {
                    v.srcObject = stream;
                } else {
                    // 防止再新的浏览器里使用它，应为它已经不再支持了
                    v.src = window.URL.createObjectURL(stream);
                }
                v.onloadedmetadata = function (e) {
                    v.play();
                    videoPlaying = true;
                };
            }).catch(err => {
                console.error(err.name + ": " + err.message);
            });

            // {#document.getElementById("stop").addEventListener("click", function () {#}
            // {#mediaStreamTrack && mediaStreamTrack.stop();#}
            // {#MediaStream.getTracks()[1] && MediaStream.getTracks()[1].remove();#}
            // {#    t.stop();#}
            // {#	隐藏vedio空间"v"#}
            // {##}
            // {##}
            // {# });#}


            $('#upload').click(function () {
                if (take) {
                    let data = canvas.toDataURL('image/png');
                    let flag = 0;

                    $.ajax({
                        url: '/upload',
                        cache: false,
                        type: 'post',
                        data: {
                            'data_url': data,
                        },
                        dataType: 'text',
                        success: function (data) {
                            getNowFormatDate();
                            document.getElementById("detectinfo").value=data;
                            var arr=data.split("\n");
                            // length=7,检测到已注册用户
                            if (arr.length==7)
                            {
                                var arr_id=arr[2].split(":");
                                var arr_name=arr[3].split(":");
                                var arr_gender=arr[4].split(":");
                                var arr_age=arr[5].split(":");
                                var arr_number=arr[6].split(":");
                                document.getElementById("u_userid").value=arr_id[1];
                                document.getElementById("userid").value=arr_id[1];
                                document.getElementById("u_name").value=arr_name[1];
                                document.getElementById("u_sex").value=arr_gender[1];
                                document.getElementById("u_age").value=arr_age[1];
                                document.getElementById("u_number").value=arr_number[1];
                            }
                            else
                            {
                                // length=4,新用户仅返回用户id
                                if(arr.length==4)
                                {
                                     document.getElementById("userid").value=arr_id[1];
                                }
                                // length=1,人脸检测失败！ 请检查网络连接和照片是否包含人脸。
                                else
                                {
                                    if(arr.length==1)
                                    {
                                        alert("人脸检测失败!");
                                        document.getElementById("u_userid").value="";
                                        document.getElementById("userid").value="";
                                        document.getElementById("u_name").value="";
                                        document.getElementById("u_sex").value="";
                                        document.getElementById("u_age").value="";
                                        document.getElementById("u_number").value="";
                                    }
                                }
                            }
                        },
                        error: function (e) {
                        }
                    });
                }
            });
        });

        // {#调用摄像头同时设置拍照按钮方法#}
        document.getElementById('tp').addEventListener('click', function () {
            if (videoPlaying) {
                canvas.width = v.videoWidth;
                canvas.height = v.videoHeight;
                canvas.getContext('2d').drawImage(v, 0, 0);
                let data = canvas.toDataURL('image/webp');
                // {#document.getElementById('photo').setAttribute('src', data);#}

                // {#                显示图片控件，隐藏摄像头控件#}
                t.stop();
                videoPlaying = false;
                v.style.display = 'none';
                canvas.style.display = 'block';
                take = true;

            } else {
                alert("请打开摄像头");
            }
        }, false);

    </script>
</div>
<div>
<div>
    <form id="register" name="form1" method="st">
			<label>编号：</label><input style="width:250px" type="text" id="u_userid" name="userbioflag" placeholder="用户user_id"><br/>
			<label>姓名：</label><input style="width:250px" type="text" id="u_name" name="username" placeholder="请输入姓名"><br/>
			<label>性别：</label><input style="width:250px" type="text" id="u_sex" name="usersex" placeholder="请输入性别"><br/>
			<label>年龄：</label><input style="width:250px" type="text" id="u_age" name="userage" placeholder="请输入年龄"><br/>
			<label>电话：</label><input style="width:250px" type="text" id="u_number" name="usernumber" placeholder="请输入电话"><br/>
    </form>
    <button class="btn btn-primary "id="submit" onclick="onSubmit()">register</button>
</div>
<!--购买记录模块-->
<div class="buy_info">
    <form id="put_info" name="form2">
        <button type="button" class="btn btn-lg btn-default" onclick="AddRow(document.getElementById('tabProduct'),1)"
               id="add">Add</button>
        <button type="button" class="btn btn-lg btn-info" id="clear" onclick="deleteRow()">Clear</button>
        <button type="button" class="btn btn-lg btn-success"onclick="GetTableData()" id="save">Save</button>
        <label id="info1">时间：</label><input type="text" name="time" id="systime" onfocus=this.blur()>
        <label id="info2">ID：</label><input type="text" name="user" id="userid" onfocus=this.blur()>
        <table width="750" border="0" cellpadding="0" cellspacing="0" id="tabProduct">
            <tr>
                <td width="50" bgcolor="#EFEFEF" Name="good_id" EditType="TextBox">商品ID</td>
                <td width="200" bgcolor="#EFEFEF" Name="good_name" EditType="TextBox">商品</td>
                <td width="103" bgcolor="#EFEFEF" Name="count" EditType="TextBox">数量</td>
                <td width="103" bgcolor="#EFEFEF" Name="total_price" EditType="TextBox">单价</td>
            </tr>
        </table>
    </form>
</div>
<!--用户推荐信息模块-->
<div class="recommend">
    <button id="GetRecom_info" type="button" class="btn btn-lg btn-success"onclick="GetRecom_info()">推荐</button>
    <button id="flush_info" type="button" class="btn btn-danger" onclick="window.location.reload()">结账</button>
</div>
<div class="panel panel-default" style="width:750px;position:absolute;margin-left:550px;margin-top:600px;">
	<div class="panel-heading">
		商品信息
	</div>
	<div class="panel-body">
		<div class="table-responsive">
			<table class="table" id="showdata">
				<thead>
					<tr>
						<th>Num</th>
						<th>Good Name</th>
						<th>Price</th>
						<th>Position</th>
					</tr>
				</thead>
				<tbody>
					<tr class="success">
						<td>1</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr class="info">
						<td>2</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr class="warning">
						<td>3</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr class="danger">
						<td>4</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr class="success">
						<td>5</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div class="tips">
<label style="position: absolute;left:600px;top:220px;font-size:20px">Message</label>
<textarea id="detectinfo" name="hint" style="position: absolute;width: 300px;height: 165px;left:600px;top:30px;"></textarea>
</div>
    <!--商品信息选择下拉框-->
<select  id="telUserName"  onchange="putValueToInput()" style="width:280px;height:28px;position:absolute;left:200px;top:312px;">
</select>
<input  type="text" name="input"  placeholder="-请选择-" id="input" onblur="inputValue()"
        style="width:258px;height:28px;position:absolute;left:200px;top:312px;"/>
 </div>
 <div class="top" style="width:280px;border:1px solid #ccc;display:none;position:absolute;left:200px;top:340px;"id="DIV">
</div>
</body>
</html>
